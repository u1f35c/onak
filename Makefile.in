#
# Makefile for onak.
#

CC = @CC@
CFLAGS += @CFLAGS@ -Wall -pedantic
# Uncomment to enable profiling.
LDFLAGS += @LDFLAGS@
# Can be "pg" for Postgresql, "file" for flat files or "db2" for pksd db2 style.
DBTYPE = @DBTYPE@
#
LIBS = @LIBS@
#MAKEDEPEND = makedepend -f- -- 
MAKEDEPEND = $(CC) -MM
prefix ?= @prefix@
exec_prefix ?= @exec_prefix@

PROGS = add lookup gpgwww onak splitkeys onak-mail.pl stripkey
CORE_OBJS = armor.o charfuncs.o decodekey.o getcgi.o hash.o \
	keyid.o keyindex.o ll.o mem.o onak-conf.o parsekey.o sha1.o md5.o \
	log.o photoid.o wordlist.o cleanup.o merge.o
SRCS = armor.c parsekey.c merge.c keyid.c md5.c sha1.c main.c getcgi.c mem.c \
	keyindex.c stats.c lookup.c add.c keydb_$(DBTYPE).c ll.c hash.c \
	gpgwww.c onak-conf.c charfuncs.c sendsync.c log.c photoid.c \
	wordlist.c cleankey.c cleanup.c

ifeq (x@KEYD@, xyes)
PROGS += keyd
KEYDB_OBJ = keydb_keyd.o
SRCS += keyd.c keydb_keyd.c
else
KEYDB_OBJ = keydb_$(DBTYPE).o
endif

OBJS = stats.o sendsync.o cleankey.o $(CORE_OBJS) $(KEYDB_OBJ)

all: .depend $(PROGS) testparse maxpath sixdegrees splitkeys onak.conf

keyd: keyd.o $(CORE_OBJS) keydb_$(DBTYPE).o
	$(CC) $(LDFLAGS) -o keyd keyd.o $(CORE_OBJS) keydb_$(DBTYPE).o $(LIBS)

splitkeys: splitkeys.o $(CORE_OBJS) $(KEYDB_OBJ)
	$(CC) $(LDFLAGS) -o splitkeys splitkeys.o $(CORE_OBJS) $(KEYDB_OBJ) \
		$(LIBS)

testparse: main.o $(OBJS)
	$(CC) $(LDFLAGS) -o testparse main.o $(OBJS) $(LIBS)

maxpath: maxpath.o $(OBJS)
	$(CC) $(LDFLAGS) -o maxpath maxpath.o $(OBJS) $(LIBS)

sixdegrees: sixdegrees.o $(OBJS)
	$(CC) $(LDFLAGS) -o sixdegrees sixdegrees.o $(OBJS) $(LIBS)

stripkey: stripkey.o $(OBJS)
	$(CC) $(LDFLAGS) -o stripkey stripkey.o $(OBJS) $(LIBS)

gpgwww: gpgwww.o $(OBJS)
	$(CC) $(LDFLAGS) -o gpgwww gpgwww.o $(OBJS) $(LIBS)

lookup: lookup.o cleankey.o $(CORE_OBJS) $(KEYDB_OBJ)
	$(CC) $(LDFLAGS) -o lookup lookup.o cleankey.o $(CORE_OBJS) \
		$(KEYDB_OBJ) $(LIBS)

add: add.o cleankey.o sendsync.o $(CORE_OBJS) $(KEYDB_OBJ)
	$(CC) $(LDFLAGS) -o add add.o cleankey.o sendsync.o \
		$(CORE_OBJS) $(KEYDB_OBJ) $(LIBS)

onak: onak.o cleankey.o $(CORE_OBJS) $(KEYDB_OBJ)
	$(CC) $(LDFLAGS) -o onak onak.o cleankey.o \
		$(CORE_OBJS) $(KEYDB_OBJ) $(LIBS)

onak-conf.o: onak-conf.c onak-conf.h
	$(CC) $(CFLAGS) -DCONFIGFILE=\"@sysconfdir@/onak.conf\" -c onak-conf.c

onak-mail.pl: onak-mail.pl.in
	sed 's:@CONFIG@:@sysconfdir@/onak.conf:g' < onak-mail.pl.in > onak-mail.pl
	chmod +x onak-mail.pl

onak.conf: onak.conf.in
	sed -e 's:@BINDIR@:@bindir@:g' \
		-e 's:@STATEDIR@:@localstatedir@:g' \
		< onak.conf.in > onak.conf

clean:
	$(RM) $(PROGS) $(OBJS) Makefile.bak testparse maxpath *.core core \
		gpgwww.o add.o lookup.o main.o maxpath.o onak.o sixdegrees \
		sixdegrees.o splitkeys.o stripkey.o onak.conf
ifeq (x@KEYD@, xyes)
	$(RM) keyd.o keydb_$(DBTYPE).o
endif

distclean: clean
	$(RM) -f Makefile .depend config.{log,status,h}
	$(RM) -r autom4te.cache

.depend: $(SRCS)
	rm -f .depend
	$(MAKEDEPEND) $(CFLAGS) $(SRCS) > .depend

include .depend

.PHONY: all clean
