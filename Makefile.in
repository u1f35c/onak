#
# Makefile for onak.
#

CC = @CC@
CFLAGS += @CFLAGS@ -Wall -pedantic
# Uncomment to enable profiling.
LDFLAGS += @LDFLAGS@
# Can be "pg" for Postgresql, "file" for flat files or "db2" for pksd db2 style.
DBTYPE = @DBTYPE@
#
LIBS = @LIBS@
prefix ?= @prefix@

PROGS = add lookup gpgwww onak splitkeys onak-mail.pl stripkey
CORE_OBJS = armor.o charfuncs.o decodekey.o getcgi.o hash.o keydb_$(DBTYPE).o \
	keyid.o keyindex.o ll.o mem.o onak-conf.o parsekey.o sha1.o md5.o \
	log.o photoid.o wordlist.o cleanup.o
OBJS = merge.o stats.o sendsync.o cleankey.o $(CORE_OBJS)
SRCS = armor.c parsekey.c merge.c keyid.c md5.c sha1.c main.c getcgi.c mem.c \
	keyindex.c stats.c lookup.c add.c keydb_$(DBTYPE).c ll.c hash.c \
	gpgwww.c onak-conf.c charfuncs.c sendsync.c log.c photoid.c \
	wordlist.c cleankey.c cleanup.c

all: .depend $(PROGS) testparse maxpath sixdegrees splitkeys

splitkeys: splitkeys.o $(CORE_OBJS)
	$(CC) $(LDFLAGS) -o splitkeys splitkeys.o $(CORE_OBJS) $(LIBS)

testparse: main.o $(OBJS)
	$(CC) $(LDFLAGS) -o testparse main.o $(OBJS) $(LIBS)

maxpath: maxpath.o $(OBJS)
	$(CC) $(LDFLAGS) -o maxpath maxpath.o $(OBJS) $(LIBS)

sixdegrees: sixdegrees.o $(OBJS)
	$(CC) $(LDFLAGS) -o sixdegrees sixdegrees.o $(OBJS) $(LIBS)

stripkey: stripkey.o $(OBJS)
	$(CC) $(LDFLAGS) -o stripkey stripkey.o $(OBJS) $(LIBS)

gpgwww: gpgwww.o $(OBJS)
	$(CC) $(LDFLAGS) -o gpgwww gpgwww.o $(OBJS) $(LIBS)

lookup: lookup.o cleankey.o merge.o $(CORE_OBJS)
	$(CC) $(LDFLAGS) -o lookup lookup.o cleankey.o merge.o $(CORE_OBJS) \
		$(LIBS)

add: add.o cleankey.o merge.o sendsync.o $(CORE_OBJS)
	$(CC) $(LDFLAGS) -o add add.o cleankey.o merge.o sendsync.o \
		$(CORE_OBJS) $(LIBS)

onak: onak.o merge.o cleankey.o $(CORE_OBJS)
	$(CC) $(LDFLAGS) -o onak onak.o merge.o cleankey.o \
		$(CORE_OBJS) $(LIBS)

onak-conf.o: onak-conf.c onak-conf.h
	$(CC) $(CFLAGS) -DCONFIGFILE=\"@sysconfdir@/onak.conf\" -c onak-conf.c

onak-mail.pl: onak-mail.pl.in
	sed 's:@CONFIG@:@sysconfdir@/onak.conf:g' < onak-mail.pl.in > onak-mail.pl
	chmod +x onak-mail.pl

clean:
	$(RM) -f $(PROGS) $(OBJS) Makefile.bak testparse maxpath *.core core \
		gpgwww.o add.o lookup.o main.o maxpath.o onak.o sixdegrees \
		sixdegrees.o splitkeys.o stripkey.o

distclean: clean
	$(RM) -f Makefile .depend config.{log,status,h}
	$(RM) -r autom4te.cache

.depend: $(SRCS)
	rm -f .depend
	makedepend -f- -- $(CFLAGS) -- $(SRCS) > .depend

include .depend

.PHONY: all clean
